# 用户权限管理系统 - 数据库设计文档

## 1. 数据库概览

### 1.1 数据库基本信息
- **数据库名称**：user_permission_system
- **数据库类型**：MySQL 8.0
- **字符集**：utf8mb4
- **排序规则**：utf8mb4_unicode_ci
- **时区**：Asia/Shanghai (+08:00)

### 1.2 设计原则
- **规范化设计**：遵循第三范式，减少数据冗余
- **性能优化**：合理设计索引，优化查询性能
- **扩展性**：预留扩展字段，支持未来功能扩展
- **安全性**：敏感数据加密存储，权限严格控制
- **审计性**：记录关键操作日志，支持数据审计

## 2. 数据表设计

### 2.1 用户表 (users)

#### 表结构
```sql
CREATE TABLE `users` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `openid` varchar(64) NOT NULL COMMENT '微信OpenID',
  `unionid` varchar(64) DEFAULT NULL COMMENT '微信UnionID',
  `nickname` varchar(100) DEFAULT NULL COMMENT '用户昵称',
  `avatar_url` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱地址',
  `real_name` varchar(50) DEFAULT NULL COMMENT '真实姓名',
  `status` enum('active','disabled','pending') NOT NULL DEFAULT 'active' COMMENT '账号状态',
  `role` enum('user','admin','super_admin') NOT NULL DEFAULT 'user' COMMENT '用户角色',
  `last_login_at` timestamp NULL DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` varchar(45) DEFAULT NULL COMMENT '最后登录IP',
  `login_count` int(11) NOT NULL DEFAULT '0' COMMENT '登录次数',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  UNIQUE KEY `uk_unionid` (`unionid`),
  KEY `idx_status` (`status`),
  KEY `idx_role` (`role`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

#### 字段说明
| 字段名 | 类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | INT | 11 | 是 | AUTO_INCREMENT | 主键，用户唯一标识 |
| openid | VARCHAR | 64 | 是 | - | 微信OpenID，用户在当前公众号的唯一标识 |
| unionid | VARCHAR | 64 | 否 | NULL | 微信UnionID，用户在同一开放平台的唯一标识 |
| nickname | VARCHAR | 100 | 否 | NULL | 用户昵称，来自微信 |
| avatar_url | VARCHAR | 255 | 否 | NULL | 用户头像URL |
| phone | VARCHAR | 20 | 否 | NULL | 手机号码 |
| email | VARCHAR | 100 | 否 | NULL | 邮箱地址 |
| real_name | VARCHAR | 50 | 否 | NULL | 真实姓名 |
| status | ENUM | - | 是 | active | 账号状态：active(正常)、disabled(禁用)、pending(待审核) |
| role | ENUM | - | 是 | user | 用户角色：user(普通用户)、admin(管理员)、super_admin(超级管理员) |
| last_login_at | TIMESTAMP | - | 否 | NULL | 最后登录时间 |
| last_login_ip | VARCHAR | 45 | 否 | NULL | 最后登录IP地址（支持IPv6） |
| login_count | INT | 11 | 是 | 0 | 累计登录次数 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |

### 2.2 权限表 (permissions)

#### 表结构
```sql
CREATE TABLE `permissions` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '权限ID',
  `user_id` int(11) NOT NULL COMMENT '用户ID',
  `permission_type` varchar(50) NOT NULL COMMENT '权限类型',
  `resource` varchar(100) DEFAULT NULL COMMENT '资源标识',
  `granted_by` int(11) NOT NULL COMMENT '授权人ID',
  `granted_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '授权时间',
  `expires_at` timestamp NULL DEFAULT NULL COMMENT '过期时间',
  `status` enum('active','revoked','expired') NOT NULL DEFAULT 'active' COMMENT '权限状态',
  `remark` varchar(255) DEFAULT NULL COMMENT '备注信息',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_permission_type` (`permission_type`),
  KEY `idx_status` (`status`),
  KEY `idx_granted_by` (`granted_by`),
  KEY `idx_expires_at` (`expires_at`),
  UNIQUE KEY `uk_user_permission` (`user_id`, `permission_type`, `resource`),
  CONSTRAINT `fk_permissions_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_permissions_granted_by` FOREIGN KEY (`granted_by`) REFERENCES `users` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='权限表';
```

#### 权限类型定义
| 权限类型 | 说明 | 资源标识示例 |
|----------|------|-------------|
| access | 基础访问权限 | * (所有资源) |
| admin | 管理员权限 | admin.* |
| user_manage | 用户管理权限 | admin.users |
| permission_manage | 权限管理权限 | admin.permissions |
| log_view | 日志查看权限 | admin.logs |
| system_config | 系统配置权限 | admin.config |

### 2.3 登录日志表 (login_logs)

#### 表结构
```sql
CREATE TABLE `login_logs` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` int(11) DEFAULT NULL COMMENT '用户ID',
  `openid` varchar(64) DEFAULT NULL COMMENT '微信OpenID',
  `login_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '登录时间',
  `ip_address` varchar(45) NOT NULL COMMENT 'IP地址',
  `user_agent` text COMMENT '用户代理信息',
  `login_type` varchar(20) NOT NULL DEFAULT 'wechat_scan' COMMENT '登录方式',
  `status` enum('success','failed','blocked') NOT NULL COMMENT '登录状态',
  `failure_reason` varchar(255) DEFAULT NULL COMMENT '失败原因',
  `session_id` varchar(128) DEFAULT NULL COMMENT '会话ID',
  `location` varchar(100) DEFAULT NULL COMMENT '登录地点',
  `device_type` varchar(50) DEFAULT NULL COMMENT '设备类型',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_openid` (`openid`),
  KEY `idx_login_time` (`login_time`),
  KEY `idx_ip_address` (`ip_address`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_login_logs_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='登录日志表';
```

### 2.4 管理员表 (admins)

#### 表结构
```sql
CREATE TABLE `admins` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '管理员ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password_hash` varchar(255) NOT NULL COMMENT '密码哈希',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱地址',
  `real_name` varchar(50) DEFAULT NULL COMMENT '真实姓名',
  `role` enum('admin','super_admin') NOT NULL DEFAULT 'admin' COMMENT '管理员角色',
  `status` enum('active','disabled') NOT NULL DEFAULT 'active' COMMENT '账号状态',
  `last_login_at` timestamp NULL DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` varchar(45) DEFAULT NULL COMMENT '最后登录IP',
  `login_count` int(11) NOT NULL DEFAULT '0' COMMENT '登录次数',
  `password_changed_at` timestamp NULL DEFAULT NULL COMMENT '密码修改时间',
  `created_by` int(11) DEFAULT NULL COMMENT '创建人ID',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_email` (`email`),
  KEY `idx_status` (`status`),
  KEY `idx_role` (`role`),
  CONSTRAINT `fk_admins_created_by` FOREIGN KEY (`created_by`) REFERENCES `admins` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='管理员表';
```

### 2.5 操作日志表 (operation_logs)

#### 表结构
```sql
CREATE TABLE `operation_logs` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `operator_id` int(11) DEFAULT NULL COMMENT '操作人ID',
  `operator_type` enum('user','admin') NOT NULL COMMENT '操作人类型',
  `operation` varchar(100) NOT NULL COMMENT '操作类型',
  `resource_type` varchar(50) NOT NULL COMMENT '资源类型',
  `resource_id` varchar(50) DEFAULT NULL COMMENT '资源ID',
  `details` json DEFAULT NULL COMMENT '操作详情',
  `ip_address` varchar(45) NOT NULL COMMENT 'IP地址',
  `user_agent` text COMMENT '用户代理',
  `result` enum('success','failed') NOT NULL COMMENT '操作结果',
  `error_message` varchar(500) DEFAULT NULL COMMENT '错误信息',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_operator` (`operator_id`, `operator_type`),
  KEY `idx_operation` (`operation`),
  KEY `idx_resource` (`resource_type`, `resource_id`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_result` (`result`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='操作日志表';
```

### 2.6 系统配置表 (system_configs)

#### 表结构
```sql
CREATE TABLE `system_configs` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '配置ID',
  `config_key` varchar(100) NOT NULL COMMENT '配置键',
  `config_value` text COMMENT '配置值',
  `config_type` enum('string','number','boolean','json') NOT NULL DEFAULT 'string' COMMENT '配置类型',
  `description` varchar(255) DEFAULT NULL COMMENT '配置描述',
  `is_public` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否公开配置',
  `created_by` int(11) DEFAULT NULL COMMENT '创建人ID',
  `updated_by` int(11) DEFAULT NULL COMMENT '更新人ID',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`),
  KEY `idx_is_public` (`is_public`),
  CONSTRAINT `fk_configs_created_by` FOREIGN KEY (`created_by`) REFERENCES `admins` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_configs_updated_by` FOREIGN KEY (`updated_by`) REFERENCES `admins` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统配置表';
```

## 3. 索引设计

### 3.1 主键索引
所有表都有自增主键，MySQL自动创建主键索引。

### 3.2 唯一索引
- `users.openid`：确保微信OpenID唯一性
- `users.unionid`：确保微信UnionID唯一性
- `admins.username`：确保管理员用户名唯一性
- `permissions.user_id + permission_type + resource`：确保用户权限唯一性
- `system_configs.config_key`：确保配置键唯一性

### 3.3 普通索引
- **用户表**：status, role, created_at
- **权限表**：user_id, permission_type, status, granted_by, expires_at
- **登录日志表**：user_id, openid, login_time, ip_address, status
- **管理员表**：email, status, role
- **操作日志表**：operator_id+operator_type, operation, resource_type+resource_id, created_at, result

### 3.4 复合索引
```sql
-- 用户权限查询优化
ALTER TABLE permissions ADD INDEX idx_user_permission_status (user_id, permission_type, status);

-- 登录日志查询优化
ALTER TABLE login_logs ADD INDEX idx_user_time_status (user_id, login_time, status);

-- 操作日志查询优化
ALTER TABLE operation_logs ADD INDEX idx_operator_time (operator_id, operator_type, created_at);
```

## 4. 数据库初始化脚本

### 4.1 创建数据库
```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS `user_permission_system` 
DEFAULT CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE `user_permission_system`;

-- 设置时区
SET time_zone = '+08:00';
```

### 4.2 创建用户和权限
```sql
-- 创建数据库用户
CREATE USER IF NOT EXISTS 'app_user'@'localhost' IDENTIFIED BY 'your_secure_password';
CREATE USER IF NOT EXISTS 'app_user'@'%' IDENTIFIED BY 'your_secure_password';

-- 授予权限
GRANT SELECT, INSERT, UPDATE, DELETE ON user_permission_system.* TO 'app_user'@'localhost';
GRANT SELECT, INSERT, UPDATE, DELETE ON user_permission_system.* TO 'app_user'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 4.3 初始化数据
```sql
-- 插入默认管理员账号
INSERT INTO `admins` (`username`, `password_hash`, `email`, `real_name`, `role`, `status`) VALUES
('admin', '$2b$10$example_hash_here', 'admin@example.com', '系统管理员', 'super_admin', 'active');

-- 插入系统配置
INSERT INTO `system_configs` (`config_key`, `config_value`, `config_type`, `description`, `is_public`) VALUES
('site_name', '呈尚策划用户权限管理系统', 'string', '网站名称', 1),
('max_login_attempts', '5', 'number', '最大登录尝试次数', 0),
('session_timeout', '86400', 'number', '会话超时时间（秒）', 0),
('enable_registration', 'true', 'boolean', '是否允许新用户注册', 0),
('wechat_login_enabled', 'true', 'boolean', '是否启用微信登录', 1);
```

## 5. 数据库维护

### 5.1 备份策略
```bash
#!/bin/bash
# 数据库备份脚本
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
DB_NAME="user_permission_system"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
mysqldump -u root -p$MYSQL_ROOT_PASSWORD \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  $DB_NAME > $BACKUP_DIR/${DB_NAME}_${DATE}.sql

# 压缩备份文件
gzip $BACKUP_DIR/${DB_NAME}_${DATE}.sql

# 删除7天前的备份
find $BACKUP_DIR -name "${DB_NAME}_*.sql.gz" -mtime +7 -delete
```

### 5.2 性能监控
```sql
-- 查看慢查询
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';

-- 查看表状态
SHOW TABLE STATUS FROM user_permission_system;

-- 查看索引使用情况
SHOW INDEX FROM users;
SHOW INDEX FROM permissions;
SHOW INDEX FROM login_logs;

-- 分析表
ANALYZE TABLE users, permissions, login_logs, admins, operation_logs, system_configs;
```

### 5.3 数据清理
```sql
-- 清理过期的登录日志（保留3个月）
DELETE FROM login_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 3 MONTH);

-- 清理过期的操作日志（保留6个月）
DELETE FROM operation_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);

-- 清理已撤销的权限记录（保留1年）
DELETE FROM permissions 
WHERE status = 'revoked' 
AND updated_at < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

## 6. 数据迁移和版本控制

### 6.1 版本控制策略
使用数据库迁移文件管理数据库结构变更：

```javascript
// migrations/001_create_initial_tables.js
const fs = require('fs');
const path = require('path');

module.exports = {
  up: async (db) => {
    const sql = fs.readFileSync(path.join(__dirname, 'sql/001_up.sql'), 'utf8');
    await db.query(sql);
  },
  
  down: async (db) => {
    const sql = fs.readFileSync(path.join(__dirname, 'sql/001_down.sql'), 'utf8');
    await db.query(sql);
  }
};
```

### 6.2 数据迁移工具
```javascript
// utils/migrate.js
const mysql = require('mysql2/promise');
const fs = require('fs');
const path = require('path');

class DatabaseMigrator {
  constructor(config) {
    this.config = config;
    this.connection = null;
  }

  async connect() {
    this.connection = await mysql.createConnection(this.config);
  }

  async createMigrationsTable() {
    const sql = `
      CREATE TABLE IF NOT EXISTS migrations (
        id INT AUTO_INCREMENT PRIMARY KEY,
        version VARCHAR(255) NOT NULL UNIQUE,
        executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `;
    await this.connection.execute(sql);
  }

  async getExecutedMigrations() {
    const [rows] = await this.connection.execute('SELECT version FROM migrations ORDER BY version');
    return rows.map(row => row.version);
  }

  async executeMigration(version, sql) {
    await this.connection.beginTransaction();
    try {
      await this.connection.execute(sql);
      await this.connection.execute('INSERT INTO migrations (version) VALUES (?)', [version]);
      await this.connection.commit();
      console.log(`Migration ${version} executed successfully`);
    } catch (error) {
      await this.connection.rollback();
      throw error;
    }
  }

  async migrate() {
    await this.connect();
    await this.createMigrationsTable();
    
    const executedMigrations = await this.getExecutedMigrations();
    const migrationFiles = fs.readdirSync(path.join(__dirname, '../migrations'))
      .filter(file => file.endsWith('.sql'))
      .sort();

    for (const file of migrationFiles) {
      const version = path.basename(file, '.sql');
      if (!executedMigrations.includes(version)) {
        const sql = fs.readFileSync(path.join(__dirname, '../migrations', file), 'utf8');
        await this.executeMigration(version, sql);
      }
    }

    await this.connection.end();
  }
}

module.exports = DatabaseMigrator;
```

这个数据库设计为您的用户权限管理系统提供了完整的数据存储方案，支持用户管理、权限控制、日志记录等核心功能，同时考虑了性能优化、数据安全和系统维护等方面的需求。
