# 呈尚策划用户权限管理系统 - 技术架构设计文档

## 1. 系统架构概览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Frontend)                      │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │
│  │   主页面     │  │   登录页面   │  │    管理后台页面      │   │
│  │ (index.html) │  │(login.html) │  │   (admin/*.html)   │   │
│  └─────────────┘  └─────────────┘  └─────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │           权限控制中间件 (Auth Middleware)               │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      API网关层 (API Gateway)                 │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Express.js 路由和中间件                     │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │  认证路由    │ │  用户路由    │ │   管理员路由     │   │ │
│  │  │ /api/auth/* │ │/api/users/* │ │ /api/admin/*   │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                     业务逻辑层 (Business Logic)               │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │
│  │  认证服务    │  │  用户服务    │  │     权限服务         │   │
│  │(AuthService) │ │(UserService) │ │(PermissionService) │   │
│  └─────────────┘  └─────────────┘  └─────────────────────┘   │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │
│  │  微信服务    │  │  日志服务    │  │     缓存服务         │   │
│  │(WechatService)│ │ (LogService) │ │  (CacheService)    │   │
│  └─────────────┘  └─────────────┘  └─────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                     数据访问层 (Data Access)                  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │
│  │   用户模型   │  │  权限模型    │  │    日志模型          │   │
│  │ (UserModel) │  │(PermModel)  │  │  (LogModel)        │   │
│  └─────────────┘  └─────────────┘  └─────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层 (Data Storage)                │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────┐    ┌─────────────────────────┐  │
│  │        MySQL 8.0        │    │        Redis 6.x       │  │
│  │    ┌─────────────────┐   │    │   ┌─────────────────┐   │  │
│  │    │   用户数据表     │   │    │   │   会话缓存       │   │  │
│  │    │   权限数据表     │   │    │   │   权限缓存       │   │  │
│  │    │   日志数据表     │   │    │   │   临时数据       │   │  │
│  │    └─────────────────┘   │    │   └─────────────────┘   │  │
│  └─────────────────────────┘    └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈选择理由

#### 1.2.1 Node.js + Express.js
**选择理由**：
- 与前端JavaScript技术栈一致，降低学习成本
- 丰富的npm生态系统，微信API集成简单
- 异步I/O特性，适合高并发场景
- 快速开发和部署

**替代方案对比**：
- Python + Flask：开发效率高，但需要额外学习Python
- Java + Spring Boot：企业级特性丰富，但复杂度较高
- PHP + Laravel：Web开发成熟，但性能相对较低

#### 1.2.2 MySQL 数据库
**选择理由**：
- 关系型数据库，适合用户权限管理的复杂关系
- ACID特性保证数据一致性
- 成熟稳定，社区支持良好
- 支持事务处理，确保权限操作的原子性

**替代方案对比**：
- PostgreSQL：功能更强大，但学习成本较高
- MongoDB：文档型数据库，但不适合复杂关系查询
- SQLite：轻量级，但不适合多用户并发场景

#### 1.2.3 JWT 认证
**选择理由**：
- 无状态认证，适合前后端分离架构
- 包含用户信息，减少数据库查询
- 支持跨域访问
- 易于扩展和集群部署

**替代方案对比**：
- Session + Cookie：传统方案，但需要服务器存储状态
- OAuth 2.0：标准化程度高，但实现复杂度较高

## 2. 详细技术设计

### 2.1 前端架构设计

#### 2.1.1 页面结构设计
```
frontend/
├── index.html              # 主页面（需要权限）
├── login.html              # 登录页面
├── waiting.html            # 等待授权页面
├── assets/
│   ├── css/
│   │   └── style.css       # 自定义样式
│   ├── js/
│   │   ├── auth.js         # 认证相关功能
│   │   ├── api.js          # API调用封装
│   │   └── utils.js        # 工具函数
│   └── images/
└── admin/                  # 管理后台
    ├── index.html          # 后台首页
    ├── users.html          # 用户管理
    ├── permissions.html    # 权限管理
    └── logs.html           # 日志管理
```

#### 2.1.2 权限控制中间件设计
```javascript
// auth.js - 前端权限控制
class AuthManager {
    constructor() {
        this.token = localStorage.getItem('auth_token');
        this.user = JSON.parse(localStorage.getItem('user_info') || '{}');
    }

    // 检查登录状态
    async checkAuth() {
        if (!this.token) {
            this.redirectToLogin();
            return false;
        }

        try {
            const response = await this.validateToken();
            if (response.valid) {
                return true;
            } else {
                this.clearAuth();
                this.redirectToLogin();
                return false;
            }
        } catch (error) {
            console.error('Auth check failed:', error);
            this.redirectToLogin();
            return false;
        }
    }

    // 检查访问权限
    async checkPermission(requiredPermission = 'access') {
        const authValid = await this.checkAuth();
        if (!authValid) return false;

        const hasPermission = await this.validatePermission(requiredPermission);
        if (!hasPermission) {
            this.redirectToWaiting();
            return false;
        }

        return true;
    }

    // 页面加载时的权限检查
    async initPageAuth(requiredPermission = 'access') {
        const hasPermission = await this.checkPermission(requiredPermission);
        if (hasPermission) {
            this.showUserInfo();
            return true;
        }
        return false;
    }
}

// 全局权限管理实例
const authManager = new AuthManager();

// 页面加载时自动执行权限检查
document.addEventListener('DOMContentLoaded', async function() {
    const currentPage = window.location.pathname;
    
    // 登录页面和等待页面不需要权限检查
    if (currentPage.includes('login.html') || currentPage.includes('waiting.html')) {
        return;
    }

    // 管理后台需要管理员权限
    const requiredPermission = currentPage.includes('/admin/') ? 'admin' : 'access';
    
    const hasPermission = await authManager.initPageAuth(requiredPermission);
    if (hasPermission) {
        // 权限验证通过，初始化页面功能
        initPageFunctions();
    }
});
```

### 2.2 后端架构设计

#### 2.2.1 项目目录结构
```
backend/
├── app.js                  # 应用入口文件
├── config/
│   ├── database.js         # 数据库配置
│   ├── redis.js            # Redis配置
│   ├── wechat.js           # 微信配置
│   └── jwt.js              # JWT配置
├── controllers/            # 控制器层
│   ├── authController.js   # 认证控制器
│   ├── userController.js   # 用户控制器
│   ├── adminController.js  # 管理员控制器
│   └── permissionController.js # 权限控制器
├── models/                 # 数据模型层
│   ├── User.js             # 用户模型
│   ├── Permission.js       # 权限模型
│   ├── LoginLog.js         # 登录日志模型
│   └── Admin.js            # 管理员模型
├── middleware/             # 中间件
│   ├── auth.js             # 认证中间件
│   ├── permission.js       # 权限中间件
│   ├── rateLimit.js        # 限流中间件
│   └── logger.js           # 日志中间件
├── routes/                 # 路由层
│   ├── auth.js             # 认证路由
│   ├── users.js            # 用户路由
│   ├── admin.js            # 管理员路由
│   └── permissions.js      # 权限路由
├── services/               # 业务服务层
│   ├── authService.js      # 认证服务
│   ├── userService.js      # 用户服务
│   ├── wechatService.js    # 微信服务
│   └── permissionService.js # 权限服务
├── utils/                  # 工具函数
│   ├── jwt.js              # JWT工具
│   ├── bcrypt.js           # 密码加密
│   ├── validator.js        # 数据验证
│   └── logger.js           # 日志工具
└── tests/                  # 测试文件
    ├── auth.test.js
    ├── user.test.js
    └── permission.test.js
```

#### 2.2.2 核心中间件设计

**认证中间件 (middleware/auth.js)**：
```javascript
const jwt = require('jsonwebtoken');
const { JWT_SECRET } = require('../config/jwt');
const User = require('../models/User');

const authMiddleware = async (req, res, next) => {
    try {
        const token = req.header('Authorization')?.replace('Bearer ', '');
        
        if (!token) {
            return res.status(401).json({ error: '访问令牌缺失' });
        }

        const decoded = jwt.verify(token, JWT_SECRET);
        const user = await User.findById(decoded.userId);

        if (!user || user.status !== 'active') {
            return res.status(401).json({ error: '用户不存在或已被禁用' });
        }

        req.user = user;
        req.token = token;
        next();
    } catch (error) {
        res.status(401).json({ error: '无效的访问令牌' });
    }
};

module.exports = authMiddleware;
```

**权限中间件 (middleware/permission.js)**：
```javascript
const Permission = require('../models/Permission');

const permissionMiddleware = (requiredPermission) => {
    return async (req, res, next) => {
        try {
            const userId = req.user.id;
            const permission = await Permission.findOne({
                user_id: userId,
                permission_type: requiredPermission,
                status: 'active'
            });

            if (!permission) {
                return res.status(403).json({ 
                    error: '权限不足',
                    required: requiredPermission 
                });
            }

            // 检查权限是否过期
            if (permission.expires_at && new Date() > permission.expires_at) {
                return res.status(403).json({ error: '权限已过期' });
            }

            req.permission = permission;
            next();
        } catch (error) {
            res.status(500).json({ error: '权限检查失败' });
        }
    };
};

module.exports = permissionMiddleware;
```

### 2.3 数据库设计详解

#### 2.3.1 数据库连接和配置
```javascript
// config/database.js
const mysql = require('mysql2/promise');

const dbConfig = {
    host: process.env.DB_HOST || 'localhost',
    port: process.env.DB_PORT || 3306,
    user: process.env.DB_USER || 'root',
    password: process.env.DB_PASSWORD || '',
    database: process.env.DB_NAME || 'user_permission_system',
    charset: 'utf8mb4',
    timezone: '+08:00',
    connectionLimit: 10,
    acquireTimeout: 60000,
    timeout: 60000
};

const pool = mysql.createPool(dbConfig);

module.exports = pool;
```

#### 2.3.2 数据模型设计
```javascript
// models/User.js
const db = require('../config/database');

class User {
    static async create(userData) {
        const { openid, nickname, avatar_url } = userData;
        const [result] = await db.execute(
            'INSERT INTO users (openid, nickname, avatar_url, status, role) VALUES (?, ?, ?, ?, ?)',
            [openid, nickname, avatar_url, 'active', 'user']
        );
        return result.insertId;
    }

    static async findByOpenid(openid) {
        const [rows] = await db.execute(
            'SELECT * FROM users WHERE openid = ? AND status = "active"',
            [openid]
        );
        return rows[0] || null;
    }

    static async findById(id) {
        const [rows] = await db.execute(
            'SELECT * FROM users WHERE id = ?',
            [id]
        );
        return rows[0] || null;
    }

    static async updateStatus(id, status) {
        const [result] = await db.execute(
            'UPDATE users SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?',
            [status, id]
        );
        return result.affectedRows > 0;
    }

    static async getList(page = 1, limit = 20, search = '', status = '') {
        let whereClause = 'WHERE 1=1';
        let params = [];

        if (search) {
            whereClause += ' AND (nickname LIKE ? OR openid LIKE ?)';
            params.push(`%${search}%`, `%${search}%`);
        }

        if (status) {
            whereClause += ' AND status = ?';
            params.push(status);
        }

        const offset = (page - 1) * limit;
        const [rows] = await db.execute(
            `SELECT id, openid, nickname, avatar_url, status, role, created_at, updated_at 
             FROM users ${whereClause} 
             ORDER BY created_at DESC 
             LIMIT ? OFFSET ?`,
            [...params, limit, offset]
        );

        const [countResult] = await db.execute(
            `SELECT COUNT(*) as total FROM users ${whereClause}`,
            params
        );

        return {
            users: rows,
            total: countResult[0].total,
            page,
            limit
        };
    }
}

module.exports = User;
```

### 2.4 微信集成设计

#### 2.4.1 微信服务封装
```javascript
// services/wechatService.js
const axios = require('axios');
const { WECHAT_APPID, WECHAT_SECRET } = require('../config/wechat');

class WechatService {
    // 获取访问令牌
    static async getAccessToken(code) {
        try {
            const response = await axios.get('https://api.weixin.qq.com/sns/oauth2/access_token', {
                params: {
                    appid: WECHAT_APPID,
                    secret: WECHAT_SECRET,
                    code: code,
                    grant_type: 'authorization_code'
                }
            });

            if (response.data.errcode) {
                throw new Error(`微信API错误: ${response.data.errmsg}`);
            }

            return response.data;
        } catch (error) {
            throw new Error(`获取微信访问令牌失败: ${error.message}`);
        }
    }

    // 获取用户信息
    static async getUserInfo(accessToken, openid) {
        try {
            const response = await axios.get('https://api.weixin.qq.com/sns/userinfo', {
                params: {
                    access_token: accessToken,
                    openid: openid,
                    lang: 'zh_CN'
                }
            });

            if (response.data.errcode) {
                throw new Error(`微信API错误: ${response.data.errmsg}`);
            }

            return {
                openid: response.data.openid,
                nickname: response.data.nickname,
                avatar_url: response.data.headimgurl
            };
        } catch (error) {
            throw new Error(`获取微信用户信息失败: ${error.message}`);
        }
    }

    // 生成微信登录URL
    static generateLoginUrl(redirectUri, state = 'STATE') {
        const params = new URLSearchParams({
            appid: WECHAT_APPID,
            redirect_uri: redirectUri,
            response_type: 'code',
            scope: 'snsapi_userinfo',
            state: state
        });

        return `https://open.weixin.qq.com/connect/oauth2/authorize?${params.toString()}#wechat_redirect`;
    }
}

module.exports = WechatService;
```

## 3. 安全架构设计

### 3.1 认证安全
- **JWT Token安全**：设置合理的过期时间，使用强密钥
- **Token刷新机制**：实现无感知的token续期
- **多设备登录控制**：限制同一用户的并发登录数量

### 3.2 权限安全
- **最小权限原则**：用户默认无权限，需要管理员授权
- **权限继承**：管理员权限包含普通用户权限
- **权限审计**：记录所有权限变更操作

### 3.3 数据安全
- **数据加密**：敏感数据加密存储
- **SQL注入防护**：使用参数化查询
- **XSS防护**：输入输出过滤和转义

### 3.4 网络安全
- **HTTPS强制**：所有通信使用HTTPS
- **CORS配置**：限制跨域访问
- **请求限流**：防止暴力攻击

## 4. 性能优化设计

### 4.1 数据库优化
- **索引优化**：为常用查询字段建立索引
- **查询优化**：避免N+1查询问题
- **连接池管理**：合理配置数据库连接池

### 4.2 缓存策略
- **Redis缓存**：缓存用户会话和权限信息
- **本地缓存**：缓存不经常变化的配置信息
- **CDN加速**：静态资源使用CDN分发

### 4.3 前端优化
- **资源压缩**：CSS/JS文件压缩
- **懒加载**：按需加载页面组件
- **缓存策略**：合理设置浏览器缓存

## 5. 监控和日志设计

### 5.1 应用监控
- **性能监控**：API响应时间、数据库查询时间
- **错误监控**：异常捕获和报警
- **业务监控**：用户登录成功率、权限授权统计

### 5.2 日志管理
- **访问日志**：记录所有API请求
- **操作日志**：记录用户和管理员操作
- **错误日志**：记录系统异常和错误

### 5.3 安全监控
- **异常登录检测**：异地登录、频繁登录监控
- **权限异常监控**：权限提升、异常访问监控
- **攻击检测**：SQL注入、XSS攻击检测

## 6. 部署架构设计

### 6.1 服务器架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Nginx (LB)    │    │   Node.js App   │    │   MySQL Master │
│   SSL终端       │────│   (主应用)       │────│   (主数据库)     │
│   静态资源       │    │   端口: 3000     │    │   端口: 3306     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                │                       │
                       ┌─────────────────┐    ┌─────────────────┐
                       │   Redis Cache   │    │  MySQL Slave    │
                       │   (缓存服务)     │    │  (从数据库)      │
                       │   端口: 6379     │    │  端口: 3307     │
                       └─────────────────┘    └─────────────────┘
```

### 6.2 容器化部署
```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=your_password
      - MYSQL_DATABASE=user_permission_system
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:6-alpine
    volumes:
      - redis_data:/data

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app

volumes:
  mysql_data:
  redis_data:
```

这个技术架构设计为您的用户权限管理系统提供了完整的技术实现方案。接下来我将继续完成其他任务，包括数据库设计和微信登录系统的具体实现。
