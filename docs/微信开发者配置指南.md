# 微信扫码登录配置指南

## 1. 微信开发者平台申请流程

### 1.1 选择合适的微信开发平台

根据您的需求，有两种主要选择：

#### 方案一：微信公众号网页授权（推荐）
**适用场景**：
- 已有微信公众号（服务号）
- 快速实现扫码登录
- 成本较低

**优势**：
- 申请流程相对简单
- 开发成本低
- 用户体验良好

**限制**：
- 需要已认证的服务号
- 只能获取基本用户信息

#### 方案二：微信开放平台网站应用
**适用场景**：
- 需要更多功能和权限
- 多平台用户统一管理
- 企业级应用

**优势**：
- 功能更全面
- 可获取unionid
- 支持多平台统一

**限制**：
- 申请流程复杂
- 需要企业资质
- 审核周期较长

### 1.2 微信公众号配置流程（推荐方案）

#### 步骤1：登录微信公众平台
1. 访问 [https://mp.weixin.qq.com/](https://mp.weixin.qq.com/)
2. 使用管理员微信扫码登录
3. 确保公众号已完成认证（服务号）

#### 步骤2：获取基本配置信息
1. 进入"开发" → "基本配置"
2. 记录以下信息：
   - **AppID**：公众号的唯一标识
   - **AppSecret**：公众号的密钥（点击重置后获取）

```javascript
// 配置示例
const WECHAT_CONFIG = {
    APPID: 'wx1234567890abcdef',        // 您的AppID
    SECRET: 'your_app_secret_here',     // 您的AppSecret
    REDIRECT_URI: 'https://yourdomain.com/api/auth/wechat/callback'
};
```

#### 步骤3：配置服务器域名
1. 在"基本配置"中找到"服务器配置"
2. 设置服务器地址（URL）：`https://yourdomain.com/api/wechat/verify`
3. 设置令牌（Token）：自定义字符串，用于验证
4. 设置消息加解密密钥（EncodingAESKey）：随机生成或自定义

#### 步骤4：配置网页授权域名
1. 进入"开发" → "接口权限" → "网页服务" → "网页帐号" → "网页授权获取用户基本信息"
2. 点击"修改"
3. 添加授权回调域名：`yourdomain.com`（不需要http://或https://前缀）

**重要提示**：
- 域名必须已备案
- 域名必须可以通过公网访问
- 建议使用HTTPS协议

#### 步骤5：配置JS接口安全域名（可选）
1. 进入"设置与开发" → "公众号设置" → "功能设置"
2. 设置"JS接口安全域名"：`yourdomain.com`
3. 下载验证文件并上传到网站根目录

## 2. 微信登录技术实现

### 2.1 前端实现

#### 2.1.1 生成微信登录链接
```javascript
// assets/js/wechat-login.js
class WechatLogin {
    constructor(config) {
        this.appId = config.appId;
        this.redirectUri = encodeURIComponent(config.redirectUri);
        this.scope = config.scope || 'snsapi_userinfo';
        this.state = config.state || 'STATE';
    }

    // 生成微信授权登录URL
    generateLoginUrl() {
        const baseUrl = 'https://open.weixin.qq.com/connect/oauth2/authorize';
        const params = [
            `appid=${this.appId}`,
            `redirect_uri=${this.redirectUri}`,
            `response_type=code`,
            `scope=${this.scope}`,
            `state=${this.state}`
        ].join('&');

        return `${baseUrl}?${params}#wechat_redirect`;
    }

    // 跳转到微信登录
    redirectToWechat() {
        const loginUrl = this.generateLoginUrl();
        window.location.href = loginUrl;
    }

    // 生成二维码登录（可选）
    generateQRCode(containerId) {
        const loginUrl = this.generateLoginUrl();
        
        // 使用qrcode.js生成二维码
        const qr = qrcode(0, 'M');
        qr.addData(loginUrl);
        qr.make();
        
        document.getElementById(containerId).innerHTML = qr.createImgTag(4);
    }
}

// 初始化微信登录
const wechatLogin = new WechatLogin({
    appId: 'wx1234567890abcdef',  // 替换为您的AppID
    redirectUri: 'https://yourdomain.com/api/auth/wechat/callback',
    scope: 'snsapi_userinfo',
    state: 'login_' + Date.now()
});
```

#### 2.1.2 登录页面HTML
```html
<!-- login.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信登录 - 呈尚策划</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
    <div class="max-w-md w-full bg-white rounded-lg shadow-md p-8">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">欢迎使用呈尚策划工具集</h1>
            <p class="text-gray-600">请使用微信扫码登录</p>
        </div>

        <!-- 微信登录按钮 -->
        <div class="space-y-4">
            <button id="wechatLoginBtn" 
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                <i class="fab fa-weixin text-xl mr-2"></i>
                微信登录
            </button>

            <!-- 二维码容器（可选） -->
            <div id="qrcode-container" class="hidden text-center">
                <p class="text-sm text-gray-600 mb-4">请使用微信扫描二维码登录</p>
                <div id="qrcode"></div>
            </div>
        </div>

        <!-- 登录状态提示 -->
        <div id="login-status" class="mt-6 text-center text-sm text-gray-600"></div>
    </div>

    <script src="assets/js/wechat-login.js"></script>
    <script>
        document.getElementById('wechatLoginBtn').addEventListener('click', function() {
            document.getElementById('login-status').textContent = '正在跳转到微信登录...';
            wechatLogin.redirectToWechat();
        });

        // 检查URL参数，处理微信回调
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');

        if (code) {
            handleWechatCallback(code, state);
        }

        async function handleWechatCallback(code, state) {
            try {
                document.getElementById('login-status').textContent = '正在处理登录信息...';
                
                const response = await fetch('/api/auth/wechat/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code, state })
                });

                const result = await response.json();

                if (response.ok) {
                    // 登录成功，保存token和用户信息
                    localStorage.setItem('auth_token', result.token);
                    localStorage.setItem('user_info', JSON.stringify(result.user));
                    
                    document.getElementById('login-status').textContent = '登录成功，正在跳转...';
                    
                    // 跳转到主页面
                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 1000);
                } else {
                    document.getElementById('login-status').textContent = `登录失败: ${result.error}`;
                }
            } catch (error) {
                console.error('登录处理失败:', error);
                document.getElementById('login-status').textContent = '登录处理失败，请重试';
            }
        }
    </script>
</body>
</html>
```

### 2.2 后端实现

#### 2.2.1 微信登录控制器
```javascript
// controllers/authController.js
const WechatService = require('../services/wechatService');
const User = require('../models/User');
const LoginLog = require('../models/LoginLog');
const jwt = require('jsonwebtoken');
const { JWT_SECRET, JWT_EXPIRES_IN } = require('../config/jwt');

class AuthController {
    // 微信登录处理
    static async wechatLogin(req, res) {
        try {
            const { code, state } = req.body;

            if (!code) {
                return res.status(400).json({ error: '微信授权码缺失' });
            }

            // 1. 使用code换取access_token
            const tokenData = await WechatService.getAccessToken(code);
            const { access_token, openid } = tokenData;

            // 2. 使用access_token获取用户信息
            const userInfo = await WechatService.getUserInfo(access_token, openid);

            // 3. 查找或创建用户
            let user = await User.findByOpenid(openid);
            
            if (!user) {
                // 新用户，自动注册
                const userId = await User.create({
                    openid: userInfo.openid,
                    nickname: userInfo.nickname,
                    avatar_url: userInfo.avatar_url
                });
                user = await User.findById(userId);
            } else {
                // 更新用户信息
                await User.updateInfo(user.id, {
                    nickname: userInfo.nickname,
                    avatar_url: userInfo.avatar_url
                });
            }

            // 4. 记录登录日志
            await LoginLog.create({
                user_id: user.id,
                ip_address: req.ip,
                user_agent: req.get('User-Agent'),
                login_type: 'wechat_scan',
                status: 'success'
            });

            // 5. 生成JWT token
            const token = jwt.sign(
                { 
                    userId: user.id, 
                    openid: user.openid,
                    role: user.role 
                },
                JWT_SECRET,
                { expiresIn: JWT_EXPIRES_IN }
            );

            // 6. 返回登录结果
            res.json({
                success: true,
                token,
                user: {
                    id: user.id,
                    nickname: user.nickname,
                    avatar_url: user.avatar_url,
                    status: user.status,
                    role: user.role
                }
            });

        } catch (error) {
            console.error('微信登录失败:', error);
            
            // 记录失败日志
            if (req.body.code) {
                await LoginLog.create({
                    user_id: null,
                    ip_address: req.ip,
                    user_agent: req.get('User-Agent'),
                    login_type: 'wechat_scan',
                    status: 'failed'
                });
            }

            res.status(500).json({ 
                error: '微信登录失败',
                details: process.env.NODE_ENV === 'development' ? error.message : undefined
            });
        }
    }

    // 验证token有效性
    static async checkAuth(req, res) {
        try {
            const user = req.user; // 来自auth中间件
            
            // 检查用户权限
            const Permission = require('../models/Permission');
            const permissions = await Permission.getUserPermissions(user.id);

            res.json({
                valid: true,
                user: {
                    id: user.id,
                    nickname: user.nickname,
                    avatar_url: user.avatar_url,
                    status: user.status,
                    role: user.role
                },
                permissions: permissions.map(p => p.permission_type)
            });
        } catch (error) {
            res.status(500).json({ error: '权限检查失败' });
        }
    }

    // 退出登录
    static async logout(req, res) {
        try {
            // 可以在这里实现token黑名单机制
            // 或者记录退出日志
            
            res.json({ success: true, message: '退出登录成功' });
        } catch (error) {
            res.status(500).json({ error: '退出登录失败' });
        }
    }
}

module.exports = AuthController;
```

#### 2.2.2 微信服务实现
```javascript
// services/wechatService.js
const axios = require('axios');
const { WECHAT_APPID, WECHAT_SECRET } = require('../config/wechat');

class WechatService {
    // 获取访问令牌
    static async getAccessToken(code) {
        try {
            const response = await axios.get('https://api.weixin.qq.com/sns/oauth2/access_token', {
                params: {
                    appid: WECHAT_APPID,
                    secret: WECHAT_SECRET,
                    code: code,
                    grant_type: 'authorization_code'
                },
                timeout: 10000 // 10秒超时
            });

            const data = response.data;

            if (data.errcode) {
                throw new Error(`微信API错误 ${data.errcode}: ${data.errmsg}`);
            }

            return {
                access_token: data.access_token,
                expires_in: data.expires_in,
                refresh_token: data.refresh_token,
                openid: data.openid,
                scope: data.scope
            };
        } catch (error) {
            if (error.response) {
                throw new Error(`微信API请求失败: ${error.response.status} ${error.response.statusText}`);
            } else if (error.request) {
                throw new Error('微信API请求超时，请检查网络连接');
            } else {
                throw new Error(`获取微信访问令牌失败: ${error.message}`);
            }
        }
    }

    // 获取用户信息
    static async getUserInfo(accessToken, openid) {
        try {
            const response = await axios.get('https://api.weixin.qq.com/sns/userinfo', {
                params: {
                    access_token: accessToken,
                    openid: openid,
                    lang: 'zh_CN'
                },
                timeout: 10000
            });

            const data = response.data;

            if (data.errcode) {
                throw new Error(`微信API错误 ${data.errcode}: ${data.errmsg}`);
            }

            return {
                openid: data.openid,
                nickname: data.nickname || '微信用户',
                avatar_url: data.headimgurl || '',
                sex: data.sex,
                province: data.province,
                city: data.city,
                country: data.country
            };
        } catch (error) {
            if (error.response) {
                throw new Error(`微信用户信息获取失败: ${error.response.status} ${error.response.statusText}`);
            } else if (error.request) {
                throw new Error('微信用户信息请求超时');
            } else {
                throw new Error(`获取微信用户信息失败: ${error.message}`);
            }
        }
    }

    // 刷新访问令牌
    static async refreshAccessToken(refreshToken) {
        try {
            const response = await axios.get('https://api.weixin.qq.com/sns/oauth2/refresh_token', {
                params: {
                    appid: WECHAT_APPID,
                    grant_type: 'refresh_token',
                    refresh_token: refreshToken
                }
            });

            const data = response.data;

            if (data.errcode) {
                throw new Error(`微信API错误 ${data.errcode}: ${data.errmsg}`);
            }

            return data;
        } catch (error) {
            throw new Error(`刷新微信访问令牌失败: ${error.message}`);
        }
    }

    // 验证访问令牌有效性
    static async validateAccessToken(accessToken, openid) {
        try {
            const response = await axios.get('https://api.weixin.qq.com/sns/auth', {
                params: {
                    access_token: accessToken,
                    openid: openid
                }
            });

            return response.data.errcode === 0;
        } catch (error) {
            return false;
        }
    }
}

module.exports = WechatService;
```

## 3. 配置文件和环境变量

### 3.1 环境变量配置
```bash
# .env 文件
# 微信配置
WECHAT_APPID=wx1234567890abcdef
WECHAT_SECRET=your_wechat_secret_here

# JWT配置
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRES_IN=24h

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_db_password
DB_NAME=user_permission_system

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# 服务器配置
PORT=3000
NODE_ENV=production

# 域名配置
DOMAIN=yourdomain.com
CALLBACK_URL=https://yourdomain.com/api/auth/wechat/callback
```

### 3.2 微信配置文件
```javascript
// config/wechat.js
module.exports = {
    WECHAT_APPID: process.env.WECHAT_APPID,
    WECHAT_SECRET: process.env.WECHAT_SECRET,
    CALLBACK_URL: process.env.CALLBACK_URL,
    
    // 微信API端点
    API_ENDPOINTS: {
        ACCESS_TOKEN: 'https://api.weixin.qq.com/sns/oauth2/access_token',
        USER_INFO: 'https://api.weixin.qq.com/sns/userinfo',
        REFRESH_TOKEN: 'https://api.weixin.qq.com/sns/oauth2/refresh_token',
        VALIDATE_TOKEN: 'https://api.weixin.qq.com/sns/auth'
    },

    // 请求配置
    REQUEST_CONFIG: {
        timeout: 10000,
        retry: 3
    }
};
```

## 4. 常见问题和解决方案

### 4.1 域名配置问题
**问题**：redirect_uri参数错误
**解决方案**：
1. 确保回调域名已在微信公众平台配置
2. 域名不要包含http://或https://前缀
3. 确保域名已备案且可公网访问

### 4.2 授权失败问题
**问题**：用户取消授权或授权失败
**解决方案**：
1. 在回调处理中检查error参数
2. 提供重新授权的选项
3. 给用户友好的错误提示

### 4.3 token过期问题
**问题**：access_token过期导致获取用户信息失败
**解决方案**：
1. 实现refresh_token机制
2. 缓存用户基本信息
3. 设置合理的token过期时间

### 4.4 网络请求超时
**问题**：微信API请求超时
**解决方案**：
1. 设置合理的超时时间
2. 实现重试机制
3. 添加错误处理和用户提示

## 5. 测试和调试

### 5.1 开发环境测试
1. 使用微信开发者工具进行调试
2. 配置本地HTTPS环境（使用ngrok等工具）
3. 在微信中打开测试链接进行真实测试

### 5.2 生产环境部署
1. 确保服务器支持HTTPS
2. 配置正确的域名和回调地址
3. 监控微信API调用日志
4. 设置错误报警机制

通过以上配置，您就可以成功实现微信扫码登录功能。记住要保护好您的AppSecret，不要在前端代码中暴露敏感信息。
